<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>bsd-cloudinit by pellaeon</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">bsd-cloudinit</h1>
        <p class="header">FreeBSD on OpenStack: cloud-init scripts for FreeBSD</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/pellaeon/bsd-cloudinit/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/pellaeon/bsd-cloudinit/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/pellaeon/bsd-cloudinit">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/pellaeon">pellaeon</a></p>


      </header>
      <section>
        <h2>
<a id="freebsd-on-openstack" class="anchor" href="#freebsd-on-openstack" aria-hidden="true"><span class="octicon octicon-link"></span></a>FreeBSD on OpenStack</h2>

<p>There has not been a complete solution to run FreeBSD instances on OpenStack, until now.</p>

<p>With bsd-cloudinit and bsd-cloudinit-installer, you could build a FreeBSD VM image that takes advantage of the cloud environment.</p>

<h2>
<a id="components" class="anchor" href="#components" aria-hidden="true"><span class="octicon octicon-link"></span></a>Components</h2>

<p>The entire project to run FreeBSD on OpenStack is called Feng Li Su (鳳梨酥), a kind of cuboid-shaped sweet Taiwanese pastry with soft crust and pineapple fillings.</p>

<p>bsd-cloudinit-installer installs bsd-cloudinit, and make <code>/etc/rc.local</code> invoke bsd-cloudinit at first boot.</p>

<h3>
<a id="bsd-cloudinit" class="anchor" href="#bsd-cloudinit" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="https://github.com/pellaeon/bsd-cloudinit">bsd-cloudinit</a>
</h3>

<p>bsd-cloudinit is a Python script based on <a href="https://github.com/cloudbase/cloudbase-init/">cloudbase-init</a> that do various tasks to prepare the FreeBSD instance for cloud environment.</p>

<p>Features:</p>

<ul>
<li>Set hostname according to OpenStack's instance name</li>
<li>Automatic SSH host key generation</li>
<li>Enlarge root partition to what the flavor provides</li>
<li>SSH public key injection</li>
<li>View instances' console message in OpenStack console log</li>
<li>Self removal after first boot</li>
</ul>

<h3>
<a id="bsd-cloudinit-installer" class="anchor" href="#bsd-cloudinit-installer" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="https://github.com/pellaeon/bsd-cloudinit-installer">bsd-cloudinit-installer</a>
</h3>

<p>A shell script to transform VM into OpenStack VM Template and installs bsd-cloudinit</p>

<p>Features:</p>

<ul>
<li>Clean SSH host key</li>
<li>Downloads and install bsd-cloudinit</li>
<li>Add bsd-cloudinit to <code>/etc/rc.local</code>
</li>
</ul>

<h2>
<a id="pre-built-image" class="anchor" href="#pre-built-image" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pre-built image</h2>

<p>We have <a href="http://images.openstack.nctu.edu.tw/bsd-cloudinit/">experimental pre-built images</a> available for download.</p>

<p>You can use the following command to upload the image to Glance</p>

<pre><code>glance image-create --name "FreeBSD 9.2" --disk-format qcow2 \
 --container-format bare &lt; freebsd-9.2-fls-cloudimage-v3.img
</code></pre>

<p>bsd-cloudinit will inject your SSH public key into the instance, just log in with username <code>freebsd</code>.</p>

<p>bsd-cloudinit will set <code>freebsd</code> and <code>root</code> user password to random for security. If for some reason bsd-cloudinit was not executed, root password will not be changed. The original root password for all our prebuilt images are <code>fenglisu</code>.</p>

<h2>
<a id="build-a-freebsd-vm-image-for-openstack" class="anchor" href="#build-a-freebsd-vm-image-for-openstack" aria-hidden="true"><span class="octicon octicon-link"></span></a>Build a FreeBSD VM image for OpenStack</h2>

<p>If you would like to build your own image, follow the guides below.</p>

<p>bsd-cloudinit-installer is the VM image maker, it transforms a VM into a OpenStack VM image.</p>

<h3>
<a id="install-freebsd-via-virt-manager" class="anchor" href="#install-freebsd-via-virt-manager" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install FreeBSD via virt-manager</h3>

<p>First you'll have to install a normal FreeBSD (only version 10.x tested) VM via virt-manager or similiar tools.</p>

<p><strong>When creating the VM, configure its disk and network to use VIRTIO</strong>. Since FreeBSD 9.2 it should be able to detect it correctly.</p>

<p><em>Note: bsd-cloudinit will set all network interfaces except <code>lo0</code>, <code>plip0</code>, <code>pflog0</code> to use DHCP!</em></p>

<p>The virtual disk size should be as small as possible, so it'll be quicker to deploy and upload. FreeBSD  requires root partition to be at least 1GB, so you should create a virtual disk slightly larger than 1GB. (We use 1.1GB in our released experimental images.)</p>

<p>The <strong>root partition must be the last partition on the disk</strong>, so that bsd-cloudinit could grow the partition on first boot.</p>

<p>There should be no need for SWAP. (there is no SWAP in the official Ubuntu cloud images either) But if you want SWAP, always make sure <code>/</code> is on the last partition.</p>

<p>After installation completes, do the following actions <strong>as root</strong> to prepare the VM for transformation.</p>

<h3>
<a id="virtio" class="anchor" href="#virtio" aria-hidden="true"><span class="octicon octicon-link"></span></a>VIRTIO</h3>

<p>If you installed on VIRTIO disk, there should be nothing to worry about.
To make sure, disk names in <code>/etc/fstab</code> should be <code>vtbd</code>.</p>

<h3>
<a id="download-and-execute-bsd-cloudinit-installer" class="anchor" href="#download-and-execute-bsd-cloudinit-installer" aria-hidden="true"><span class="octicon octicon-link"></span></a>Download and execute bsd-cloudinit-installer</h3>

<p>The installer will modify some system configuration files, and install bsd-cloudinit and its Python dependencies.</p>

<pre><code>fetch --no-verify-peer https://raw.github.com/pellaeon/bsd-cloudinit-installer/master/installer.sh
chmod +x installer.sh
./installer.sh
</code></pre>

<p>After this step, the VM is no longer a normal VM and not suitable for use with virt-manager.</p>

<p>Follow instruction of the installer to clean command history.</p>

<p>Shutdown</p>

<pre><code>shutdown -p now
</code></pre>

<p>After shutting down, the VM's virtual disk is ready to be deployed in OpenStack, just upload it to Glance</p>

<pre><code>glance image-create --name "FreeBSD 9.2" --disk-format qcow2 \
 --container-format bare &lt; freebsd-9.2-fls-cloudimage-v3.img
</code></pre>

<p>Then the image is ready to be deployed! Launch an instance to test it!</p>

<h3>
<a id="further-configurations" class="anchor" href="#further-configurations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Further configurations</h3>

<p>FreeBSD currently does not support DHCP <code>interface-mtu</code> option (<a href="https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=187094">bug 187094</a>). If your VM internal network uses MTU other than 1500, FreeBSD will ignore the option from the assigning DHCP server. You can work around this by manually setting the interface MTU in <code>/etc/rc.local</code>:</p>

<pre><code>ifconfig vtnet0 mtu 1450
</code></pre>

<h2>
<a id="planned-features" class="anchor" href="#planned-features" aria-hidden="true"><span class="octicon octicon-link"></span></a>Planned Features</h2>

<ul>
<li>port cloudinit's <a href="http://cloudinit.readthedocs.org/en/latest/topics/examples.html">cloudconfig</a> parser to enable further customization of instance</li>
<li>Xen image</li>
<li>
<code>ntpdate</code> on first boot</li>
<li>to shrink image size, use custom kernel without unnecessary features, remove unnecessary kernel modules</li>
</ul>

<h2>
<a id="changelog" class="anchor" href="#changelog" aria-hidden="true"><span class="octicon octicon-link"></span></a>Changelog</h2>

<ul>
<li>1312041: Fix <code>/home/freebsd</code> wrong permission.</li>
<li>2014/06/30: Auto Python module installation in installer</li>
<li>2015/01/25: Released 9.3 and 10.1 images</li>
</ul>

<h2>
<a id="authors-and-contributors" class="anchor" href="#authors-and-contributors" aria-hidden="true"><span class="octicon octicon-link"></span></a>Authors and Contributors</h2>

<p>bsd-cloudinit is built by <a href="https://github.com/pellaeon" class="user-mention">@pellaeon</a>, <a href="https://github.com/apua" class="user-mention">@apua</a>, <a href="https://github.com/iblis17" class="user-mention">@iblis17</a> from Information Technology Service Center
 of National Chiao Tung University in Taiwan.</p>

<ul>
<li>
<a href="https://github.com/pellaeon" class="user-mention">@pellaeon</a> is the maintainer and takes care of the documentation, planning, coordinating, communications with users.</li>
<li>
<a href="https://github.com/iblis17" class="user-mention">@iblis17</a> takes care of the shell script parts.</li>
<li>
<a href="https://github.com/apua" class="user-mention">@apua</a> takes care of the Python bits.</li>
</ul>

<p>This project is based on <a href="https://github.com/cloudbase/cloudbase-init">cloudbase-init</a>, we share most of non-OS-specific code. Great thanks to them.</p>

<h2>
<a id="donation" class="anchor" href="#donation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Donation</h2>

<p>If you like our project, please consider sending Bitcoin to <code>17sei77Rt29wQ7cx4hqznQ2esMA49Fj9KQ</code></p>

<h2>
<a id="users" class="anchor" href="#users" aria-hidden="true"><span class="octicon octicon-link"></span></a>Users</h2>

<p><img src="https://www.digitalocean.com/assets/images/logos-badges/png/DO_Logo_Vertical_Blue-75e0d68b.png" alt="DigitalOcean"></p>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
